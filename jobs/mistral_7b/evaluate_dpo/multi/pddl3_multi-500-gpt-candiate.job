#!/bin/bash

#$ -M jfan5@nd.edu
#$ -m abe
#$ -q gpu
#$ -l gpu_card=1
#$ -o job_outputs/evaluate/mistral/multi_scenarios/pddl3_multi-500.o
#$ -pe smp 8
#$ -N eval_mistral_multi_pddl3-500
#$ -t 1-7

set -euo pipefail


conda activate llmstl

MODEL_PATH="/groups/fkong/jfan5/dpo_models/mistral_7b/multi/pddl3_500-gpt-candidate"

if [[ -z "${SGE_TASK_ID:-}" ]]; then
  echo "SGE_TASK_ID is not set. Please run this script via qsub with an array range." >&2
  exit 1
fi

declare -a SCENARIOS=(
  "blocksworld"
  "ferry"
  "delivery"
  "grid"
  "grippers"
  "rovers"
  "spanner"
)

scenario_name="${SCENARIOS[$((SGE_TASK_ID-1))]}"

case "${scenario_name}" in
  blocksworld)
    PROBLEMS_DIR="blocksworld/all_problems3/testing"
    DOMAIN_FILE="blocksworld/domain3.pddl"
    ;;
  ferry)
    PROBLEMS_DIR="ferry/all_problems3/testing"
    DOMAIN_FILE="ferry/domain3.pddl"
    ;;
  grid)
    PROBLEMS_DIR="grid/all_problems3/testing"
    DOMAIN_FILE="grid/domain3.pddl"
    ;;
  grippers)
    PROBLEMS_DIR="grippers/all_problems3/testing"
    DOMAIN_FILE="grippers/domain3.pddl"
    ;;
  rovers)
    PROBLEMS_DIR="rovers/all_problems3/testing"
    DOMAIN_FILE="rovers/domain3.pddl"
    ;;
  spanner)
    PROBLEMS_DIR="spanner/all_problems3/testing"
    DOMAIN_FILE="spanner/domain3.pddl"
    ;;
  delivery)
    PROBLEMS_DIR="delivery/all_problems3/testing"
    DOMAIN_FILE="delivery/domain3.pddl"
    ;;
  *)
    echo "Unsupported scenario: ${scenario_name}" >&2
    exit 1
    ;;
esac

RESULTS_DIR="planning_results/dpo_mistral_7b-multi-gpt-candidate-500/${scenario_name}/50"
OUTPUT_NAME="${scenario_name}_multi_pddl3_50-500.json"

echo "=========================================="
echo "Model path: ${MODEL_PATH}"
echo "Scenario: ${scenario_name}"
echo "Problems dir: ${PROBLEMS_DIR}"
echo "Domain file: ${DOMAIN_FILE}"
echo "Results dir: ${RESULTS_DIR}"
echo "=========================================="

python3 script/evaluate_llm_solver.py \
  --model "${MODEL_PATH}" \
  --problems-dir "${PROBLEMS_DIR}" \
  --domain-file "${DOMAIN_FILE}" \
  --max-problems 50 \
  --output "${OUTPUT_NAME}" \
  --results-dir "${RESULTS_DIR}"
