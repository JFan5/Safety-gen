#!/bin/bash

#$ -M jfan5@nd.edu
#$ -m abe
#$ -q gpu
#$ -l gpu_card=1
#$ -pe smp 8
#$ -o /users/jfan5/jfan5/Safety-gen/job_outputs/dpo/mistral_7b/multi_scenarios/pddl3_crc-500.o
#$ -N dpo_mistral_multi_pddl3-500

set -euo pipefail

conda activate llmstl

BASE_MODEL="/groups/fkong/jfan5/sft_models/mistral_7b/multi_scenarios500/pddl3"
DPO_DATASET="/groups/fkong/jfan5/data/dpo/mistral_unsloth/multi_scenarios/pddl3_dpo.jsonl"
OUTPUT_DIR="/groups/fkong/jfan5/dpo_models/mistral_7b/multi_scenarios500/pddl3"

mkdir -p "${OUTPUT_DIR}"

python3 /users/jfan5/jfan5/Safety-gen/script/train_dpo_unsloth.py \
  --base_model "${BASE_MODEL}" \
  --dataset "${DPO_DATASET}" \
  --output_dir "${OUTPUT_DIR}" \
  --num_epochs 3 \
  --batch_size 2 \
  --gradient_accumulation_steps 4 \
  --run_name "dpo-mistral-multi-pddl3-500" \
  --lora_r 16 \
  --lora_alpha 32 \
  --lora_dropout 0.05 \
  --reference_free \
  --use_gradient_checkpointing \
  --memory_efficient
