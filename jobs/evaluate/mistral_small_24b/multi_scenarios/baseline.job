#!/bin/bash

#$ -M jfan5@nd.edu
#$ -m abe
#$ -q gpu
#$ -l gpu_card=1
#$ -o job_outputs/evaluate_mistral_small_24b_multi_scenarios_baseline.o
#$ -pe smp 8          # Specify parallel environment and legal core size
#$ -N evaluate_mistral_small_24b_multi_scenarios_baseline     # Specify job name
#$ -t 1-6               # One task per scenario

conda activate llmstl

if [[ -z "${SGE_TASK_ID:-}" ]]; then
  echo "SGE_TASK_ID is not set. Please run this script via qsub with an array range." >&2
  exit 1
fi

BASE_MODEL="unsloth/Mistral-Small-3.2-24B-Instruct-2506"

declare -a SCENARIOS=(
  "blocksworld"
  "ferry"
  "grid"
  "grippers"
  "rovers"
  "spanner"
)

scenario_name="${SCENARIOS[$((SGE_TASK_ID-1))]}"

case "${scenario_name}" in
  blocksworld)
    PROBLEMS_DIR="blocksworld/all_problems3/testing"
    DOMAIN_FILE="blocksworld/domain3.pddl"
    ;;
  ferry)
    PROBLEMS_DIR="ferry/all_problems3/testing"
    DOMAIN_FILE="ferry/domain3.pddl"
    ;;
  grid)
    PROBLEMS_DIR="grid/all_problems3/testing"
    DOMAIN_FILE="grid/domain3.pddl"
    ;;
  grippers)
    PROBLEMS_DIR="grippers/all_problems3/testing"
    DOMAIN_FILE="grippers/domain3.pddl"
    ;;
  rovers)
    PROBLEMS_DIR="rovers/all_problems3/testing"
    DOMAIN_FILE="rovers/domain3.pddl"
    ;;
  spanner)
    PROBLEMS_DIR="spanner/all_problems3/testing"
    DOMAIN_FILE="spanner/domain3.pddl"
    ;;
  *)
    echo "Unsupported scenario: ${scenario_name}" >&2
    exit 1
    ;;
esac

RESULTS_DIR="planning_results/mistral_small_24b/${scenario_name}/baseline"
OUTPUT_NAME="${scenario_name}_baseline_results.json"

mkdir -p "${RESULTS_DIR}"

echo "=========================================="
echo "Evaluating base model: ${BASE_MODEL}"
echo "Scenario: ${scenario_name}"
echo "Problems dir: ${PROBLEMS_DIR}"
echo "Domain file: ${DOMAIN_FILE}"
echo "Results dir: ${RESULTS_DIR}"
echo "=========================================="

python3 script/evaluate_llm_solver.py \
  --model "${BASE_MODEL}" \
  --problems-dir "${PROBLEMS_DIR}" \
  --domain-file "${DOMAIN_FILE}" \
  --max-problems 100 \
  --output "${OUTPUT_NAME}" \
  --results-dir "${RESULTS_DIR}"
