#!/bin/bash
# Discover planning evaluation gaps and submit the corresponding CRC jobs via qsub.

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export REPO_ROOT

mapfile -t LINES < <(python - <<'PY'
from pathlib import Path
import os

repo = Path(os.environ["REPO_ROOT"]).resolve()
sft_root = (repo / "sft_models").resolve()
planning_root = (repo / "planning_results").resolve()
jobs_root = repo / "jobs" / "evaluate"

model_dir_map = {
    "mistral_7b": "mistral",
}

def iter_models(root: Path):
    for entry in sorted(root.iterdir()):
        if entry.name in {"inventory.md", "README.md", "sft_models"}:
            continue
        if entry.is_dir():
            yield entry

def collect_variants(model_path: Path):
    for scenario_dir in sorted(model_path.iterdir()):
        if not scenario_dir.is_dir():
            continue
        variants = []
        for child in sorted(scenario_dir.iterdir()):
            if child.is_dir() and child.name.startswith("pddl"):
                variants.append(child.name)
        if variants:
            yield scenario_dir.name, variants

models_in_sft = [m.name for m in iter_models(sft_root)]
models_in_results = {
    entry.name for entry in planning_root.iterdir()
    if entry.is_dir()
}

missing_models = [m for m in models_in_sft if m not in models_in_results]
for model in missing_models:
    print(f"MODEL_MISSING\t{model}")

jobs_to_submit = []
missing_job_scripts = []

for model_name in models_in_sft:
    model_path = sft_root / model_name
    plan_model_root = planning_root / model_name
    job_model_name = model_dir_map.get(model_name, model_name)
    for scenario, variants in collect_variants(model_path):
        for variant in variants:
            plan_dir = plan_model_root / scenario / variant
            if plan_dir.exists():
                continue
            job_dir = jobs_root / job_model_name / scenario
            job_path = job_dir / f"{variant}_crc.job"
            if job_path.exists():
                jobs_to_submit.append(job_path.relative_to(repo))
            else:
                missing_job_scripts.append((model_name, scenario, variant, str(job_dir.relative_to(repo)) if job_dir.exists() else None))

for job in jobs_to_submit:
    print(f"QUEUE\t{job}")

for model, scenario, variant, job_dir in missing_job_scripts:
    if job_dir is None:
        ref = f"{model}/{scenario}/{variant} (job dir missing)"
    else:
        ref = f"{model}/{scenario}/{variant} (expected under {job_dir})"
    print(f"NOJOB\t{ref}")
PY)

declare -a JOBS=()
declare -a MISSING_MODELS=()
declare -a MISSING_SCRIPTS=()

for line in "${LINES[@]}"; do
  IFS=$'\t' read -r kind value <<<"${line}"
  case "${kind}" in
    MODEL_MISSING)
      MISSING_MODELS+=("${value}")
      ;;
    QUEUE)
      JOBS+=("${value}")
      ;;
    NOJOB)
      MISSING_SCRIPTS+=("${value}")
      ;;
  esac
done

if (("${#MISSING_MODELS[@]}" > 0)); then
  echo "Models present in sft_models but missing entirely from planning_results:"
  for model in "${MISSING_MODELS[@]}"; do
    echo "  - ${model}"
  done
  echo
fi

TIMESTAMP="$(date '+%Y%m%d_%H%M%S')"
OUTPUT_SCRIPT="/tmp/queued_planning_jobs_${TIMESTAMP}.sh"

if (("${#JOBS[@]}" == 0)); then
  echo "No pending planning jobs detected."
else
  echo "Found ${#JOBS[@]} pending planning jobs."
  {
    echo "#!/bin/bash"
    echo "# Autogenerated by shells/submit_missing_planning_jobs.sh on $(date '+%Y-%m-%d %H:%M:%S')"
    echo "# Run this script to submit the outstanding planning evaluations."
    echo "set -euo pipefail"
    echo
    for job in "${JOBS[@]}"; do
      echo "qsub ${job}"
    done
  } > "${OUTPUT_SCRIPT}"
  chmod +x "${OUTPUT_SCRIPT}"
  echo "Queued qsub commands written to ${OUTPUT_SCRIPT}"
  echo "Run: bash ${OUTPUT_SCRIPT}"
fi

if (("${#MISSING_SCRIPTS[@]}" > 0)); then
  echo
  echo "Missing job scripts (cannot submit automatically):"
  for ref in "${MISSING_SCRIPTS[@]}"; do
    echo "  - ${ref}"
  done
fi
